language: python
git:
  depth: 3
cache: pip
matrix:
  # mark build as complete as soon as the versions that may not fail is finished
  fast_finish: true
  include:
    - python: 3.6
      dist: trusty
      addons:
        postgresql: '9.5'
    - python: 3.7
      dist: xenial
      #env: NO_RMQ='t'
      addons:
        postgresql: '9.5'
        apt:
          packages:
            - rabbitmq-server
    - python: 3.8
      dist: xenial
      addons:
        postgresql: '9.5'
        apt:
          packages:
            - rabbitmq-server
services:
  - postgresql
  - rabbitmq
before_install:
  # Now we install the needed dependencies
  - sudo apt-get install locate
  - sudo service postgresql stop
  - sudo apt-get remove postgresql
  - sudo apt-get install postgresql-9.5
  - sudo updatedb
install: # python installations
  - pip install -U pip wheel setuptools
  # install package and requirements for tests
  - pip install -e .[testing]
script:
  # refresh entry points
  - reentry scan
  # run tests
  - cd tests; pytest --cov-report=term-missing --cov=aiida_jutools -sv .
after_success:
  - pip install codecov
  - codecov
